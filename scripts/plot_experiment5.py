import json
import matplotlib.pyplot as plt
from pathlib import Path
import sys

divergences = {('bg', 'cs'): 5.779367890498415, 
               ('bg', 'da'): 5.765412668008769, 
               ('bg', 'de'): 5.748527267750894, 
               ('bg', 'el'): 5.8189150613038, 
               ('bg', 'en'): 5.796630706421402, 
               ('bg', 'es'): 5.786603264718668, 
               ('bg', 'et'): 5.7801733405954945, 
               ('bg', 'fi'): 5.767339422475162, 
               ('bg', 'fr'): 5.7733549075786526, 
               ('bg', 'hu'): 5.756785919291453, 
               ('bg', 'it'): 5.8040817254812795, 
               ('bg', 'lt'): 5.769985441644767, 
               ('bg', 'lv'): 5.787881367935471, 
               ('bg', 'nl'): 5.792299493824102, 
               ('bg', 'pl'): 5.791637005210985, ('bg', 'pt'): 5.75151526488517, ('bg', 'ro'): 5.77032154247111, ('bg', 'sk'): 5.783874907415245, ('bg', 'sl'): 5.78400821925067, ('bg', 'sv'): 5.827674757893495, ('cs', 'bg'): 4.995487959968848, ('cs', 'da'): 4.319281782691354, ('cs', 'de'): 4.266748841775969, ('cs', 'el'): 5.015128804948006, ('cs', 'en'): 4.295621181594517, ('cs', 'es'): 4.095495544664016, ('cs', 'et'): 4.120049145192187, ('cs', 'fi'): 4.073691004622579, ('cs', 'fr'): 4.053723648015401, ('cs', 'hu'): 3.828521984473184, ('cs', 'it'): 4.1432290221343635, ('cs', 'lt'): 4.068436946615413, ('cs', 'lv'): 4.129588395780309, ('cs', 'nl'): 4.134048341257998, ('cs', 'pl'): 3.5623129773971023, ('cs', 'pt'): 3.9041683062028896, ('cs', 'ro'): 3.8950226985305005, ('cs', 'sk'): 1.9583556080000848, ('cs', 'sl'): 3.2150690040389134, ('cs', 'sv'): 4.3233009028683504, ('da', 'bg'): 4.442555043005172, ('da', 'cs'): 3.7447368738773767, ('da', 'de'): 3.3025439479406296, ('da', 'el'): 4.477069286784273, ('da', 'en'): 3.4843644553882136, ('da', 'es'): 3.6055490230044125, ('da', 'et'): 3.6855841541361642, ('da', 'fi'): 3.6525602746141077, ('da', 'fr'): 3.5344823108338574, ('da', 'hu'): 3.552968761518002, ('da', 'it'): 3.408809186026776, ('da', 'lt'): 3.7082947112967957, ('da', 'lv'): 3.6178428160697553, ('da', 'nl'): 3.1506405681287815, ('da', 'pl'): 3.614693396338273, ('da', 'pt'): 3.568894630007328, ('da', 'ro'): 3.414157444316874, ('da', 'sk'): 3.7086793980178374, ('da', 'sl'): 3.630862805453602, ('da', 'sv'): 2.4161777049688182, ('de', 'bg'): 5.126599688335177, ('de', 'cs'): 4.55699310813042, ('de', 'da'): 3.9053945354011126, ('de', 'el'): 5.138579477037424, ('de', 'en'): 4.367786194101283, ('de', 'es'): 4.444194891108448, ('de', 'et'): 4.383086345207566, ('de', 'fi'): 4.436883778207186, ('de', 'fr'): 4.4323343372005946, ('de', 'hu'): 4.374012152487925, ('de', 'it'): 4.395739439241735, ('de', 'lt'): 4.347215778040948, ('de', 'lv'): 4.512637824645283, ('de', 'nl'): 3.625681523634361, ('de', 'pl'): 4.406769620057213, ('de', 'pt'): 4.411609005202221, ('de', 'ro'): 4.317660607338983, ('de', 'sk'): 4.4202703179725615, ('de', 'sl'): 4.480267850425252, ('de', 'sv'): 4.102882856493091, ('el', 'bg'): 7.403158725238798, ('el', 'cs'): 7.382800634453831, ('el', 'da'): 7.381757515628586, ('el', 'de'): 7.369861485011065, ('el', 'en'): 7.414439637594081, ('el', 'es'): 7.3928111928354605, ('el', 'et'): 7.389572890402486, ('el', 'fi'): 7.386333660966607, ('el', 'fr'): 7.38620549135323, ('el', 'hu'): 7.378465634252812, ('el', 'it'): 7.392325466499194, ('el', 'lt'): 7.367024786023714, ('el', 'lv'): 7.378356065265014, ('el', 'nl'): 7.403402962413019, ('el', 'pl'): 7.388079935600474, ('el', 'pt'): 7.377271222031645, ('el', 'ro'): 7.390214834075234, ('el', 'sk'): 7.377932499016875, ('el', 'sl'): 7.3825671890019535, ('el', 'sv'): 7.437868675832281, ('en', 'bg'): 4.381430197206545, ('en', 'cs'): 3.6478451158156573, ('en', 'da'): 3.4673433053563354, ('en', 'de'): 3.5627031500655297, ('en', 'el'): 4.383369084622656, ('en', 'es'): 3.6871917980314866, ('en', 'et'): 3.6486727900385003, ('en', 'fi'): 3.7074386882396104, ('en', 'fr'): 3.422188455009503, ('en', 'hu'): 3.749016376586961, ('en', 'it'): 3.475669182887217, ('en', 'lt'): 3.828919741542566, ('en', 'lv'): 3.7674555976947453, ('en', 'nl'): 3.089903916244882, ('en', 'pl'): 3.535939489217954, ('en', 'pt'): 3.529083257995957, ('en', 'ro'): 3.3155419692752006, ('en', 'sk'): 3.677139058916247, ('en', 'sl'): 3.629951494417747, ('en', 'sv'): 3.5560835206201857, ('es', 'bg'): 4.900673433260273, ('es', 'cs'): 4.16366725416772, ('es', 'da'): 3.842701725105775, ('es', 'de'): 4.223479967209548, ('es', 'el'): 4.935382653793096, ('es', 'en'): 3.906549281595258, ('es', 'et'): 3.9489454269604245, ('es', 'fi'): 3.8559767773685327, ('es', 'fr'): 2.838696549207064, ('es', 'hu'): 3.865292616269499, ('es', 'it'): 3.210042363671785, ('es', 'lt'): 3.9600442316774833, ('es', 'lv'): 4.143747437862632, ('es', 'nl'): 3.6182312844791764, ('es', 'pl'): 4.044235006581948, ('es', 'pt'): 2.2590866319932097, ('es', 'ro'): 3.1227352818004195, ('es', 'sk'): 4.229938643085679, ('es', 'sl'): 3.9750526708785228, ('es', 'sv'): 3.7976992888790106, ('et', 'bg'): 4.177254089445429, ('et', 'cs'): 3.299145345143495, ('et', 'da'): 3.3420709841224068, ('et', 'de'): 3.2615483550541207, ('et', 'el'): 4.154480889223082, ('et', 'en'): 3.484817562083665, ('et', 'es'): 3.492815707804897, ('et', 'fi'): 2.4710919196424364, ('et', 'fr'): 3.2942886808406713, ('et', 'hu'): 3.271847353497496, ('et', 'it'): 3.340244461192913, ('et', 'lt'): 3.1645690077567057, ('et', 'lv'): 3.1886004499564233, ('et', 'nl'): 3.2252312803491687, ('et', 'pl'): 3.2849631856330817, ('et', 'pt'): 3.434822695406372, ('et', 'ro'): 3.293393522369632, ('et', 'sk'): 3.3250826187909146, ('et', 'sl'): 3.215170282831924, ('et', 'sv'): 3.2827035269490525, ('fi', 'bg'): 4.403897748384496, ('fi', 'cs'): 3.574844974846945, ('fi', 'da'): 3.6981217634009784, ('fi', 'de'): 3.4972925699372746, ('fi', 'el'): 4.3803640534849215, ('fi', 'en'): 3.8343364326752503, ('fi', 'es'): 3.78295772516006, ('fi', 'et'): 2.731664776429275, ('fi', 'fr'): 3.6860226234367857, ('fi', 'hu'): 3.5538318118018806, ('fi', 'it'): 3.6651286364751225, ('fi', 'lt'): 3.442924445450546, ('fi', 'lv'): 3.564267157019671, ('fi', 'nl'): 3.557341620804277, ('fi', 'pl'): 3.578474385945793, ('fi', 'pt'): 3.7950694202434283, ('fi', 'ro'): 3.6323071109307636, ('fi', 'sk'): 3.5702373937050154, ('fi', 'sl'): 3.585485515422413, ('fi', 'sv'): 3.4320010862698678, ('fr', 'bg'): 5.838824585909943, ('fr', 'cs'): 4.854474411583514, ('fr', 'da'): 4.362341605813907, ('fr', 'de'): 4.717694240237408, ('fr', 'el'): 5.71801775021645, ('fr', 'en'): 4.386920317100303, ('fr', 'es'): 3.932173678128948, ('fr', 'et'): 4.606900279854264, ('fr', 'fi'): 4.818993538788298, ('fr', 'hu'): 4.765571000412824, ('fr', 'it'): 3.8293267022337414, ('fr', 'lt'): 4.785443166162402, ('fr', 'lv'): 4.965070896419796, ('fr', 'nl'): 4.13287617080211, ('fr', 'pl'): 4.861916308832187, ('fr', 'pt'): 4.076627729820919, ('fr', 'ro'): 3.949670564980045, ('fr', 'sk'): 4.973163505787136, ('fr', 'sl'): 4.885716247372465, ('fr', 'sv'): 4.659994428580274, ('hu', 'bg'): 5.0864080004402785, ('hu', 'cs'): 3.8128781286896767, ('hu', 'da'): 4.495900728123489, ('hu', 'de'): 4.333737002078994, ('hu', 'el'): 5.122491854497752, ('hu', 'en'): 4.3616520766041145, ('hu', 'es'): 4.127421393869876, ('hu', 'et'): 4.163994743584914, ('hu', 'fi'): 4.2052997967456385, ('hu', 'fr'): 4.246272202242068, ('hu', 'it'): 4.272733075915439, ('hu', 'lt'): 4.297488065816713, ('hu', 'lv'): 4.421555952048524, ('hu', 'nl'): 4.32109312765609, ('hu', 'pl'): 4.097582225657448, ('hu', 'pt'): 4.096907918335165, ('hu', 'ro'): 4.0828080609390724, ('hu', 'sk'): 3.8331046810140705, ('hu', 'sl'): 4.209985176688169, ('hu', 'sv'): 4.425571329987199, ('it', 'bg'): 4.83965521365217, ('it', 'cs'): 4.039615992341089, ('it', 'da'): 4.038140319391326, ('it', 'de'): 3.9467769805182655, ('it', 'el'): 4.79695140136144, ('it', 'en'): 3.708408293001366, ('it', 'es'): 3.1322971450138373, ('it', 'et'): 3.775002716641044, ('it', 'fi'): 3.866441476711316, ('it', 'fr'): 3.271453253586095, ('it', 'hu'): 4.000483477707287, ('it', 'lt'): 3.8481566755338967, ('it', 'lv'): 3.9334341829677237, ('it', 'nl'): 3.784389524301888, ('it', 'pl'): 3.881125121417098, ('it', 'pt'): 3.240197779921977, ('it', 'ro'): 3.120122658094675, ('it', 'sk'): 4.002732399635184, ('it', 'sl'): 3.93876311712007, ('it', 'sv'): 3.9985556191188, ('lt', 'bg'): 3.931689962635497, ('lt', 'cs'): 3.1709424631354426, ('lt', 'da'): 3.3765375379159193, ('lt', 'de'): 3.308284431046229, ('lt', 'el'): 3.9371627887685685, ('lt', 'en'): 3.4951463774334255, ('lt', 'es'): 3.3039454134631026, ('lt', 'et'): 3.153577661942569, ('lt', 'fi'): 3.0509782176856306, ('lt', 'fr'): 3.301812690834486, ('lt', 'hu'): 3.298696579486081, ('lt', 'it'): 3.2738448998065803, ('lt', 'lv'): 2.662566781666475, ('lt', 'nl'): 3.3970552537171033, ('lt', 'pl'): 3.153307745203306, ('lt', 'pt'): 3.2407596902690603, ('lt', 'ro'): 3.220578667386984, ('lt', 'sk'): 3.1816631951339107, ('lt', 'sl'): 3.0795983413119767, ('lt', 'sv'): 3.3660441421408933, ('lv', 'bg'): 4.128071985964927, ('lv', 'cs'): 3.3995181945226087, ('lv', 'da'): 3.507683907087496, ('lv', 'de'): 3.4144475127156357, ('lv', 'el'): 4.132898306894952, ('lv', 'en'): 3.57897131420745, ('lv', 'es'): 3.4172572661256364, ('lv', 'et'): 3.212408154556086, ('lv', 'fi'): 3.270789693945388, ('lv', 'fr'): 3.407784041415696, ('lv', 'hu'): 3.4872674811171818, ('lv', 'it'): 3.411929833136401, ('lv', 'lt'): 2.788549122001438, ('lv', 'nl'): 3.567016407702758, ('lv', 'pl'): 3.3881415079370893, ('lv', 'pt'): 3.416724877478729, ('lv', 'ro'): 3.3145097636529917, ('lv', 'sk'): 3.4033006283837812, ('lv', 'sl'): 3.2807796154805704, ('lv', 'sv'): 3.5264292401684294, ('nl', 'bg'): 5.300065096780403, ('nl', 'cs'): 4.576212476665196, ('nl', 'da'): 3.7902317547281728, ('nl', 'de'): 3.9360715322835476, ('nl', 'el'): 5.2644950571728595, ('nl', 'en'): 4.16705938992264, ('nl', 'es'): 4.008095054436886, ('nl', 'et'): 4.258820059738693, ('nl', 'fi'): 4.280359138044546, ('nl', 'fr'): 3.949363134987657, ('nl', 'hu'): 4.100999161314534, ('nl', 'it'): 4.360445715206054, ('nl', 'lt'): 4.576758368682029, ('nl', 'lv'): 4.639836796241031, ('nl', 'pl'): 4.468673825196042, ('nl', 'pt'): 4.128441797971984, ('nl', 'ro'): 4.015880312246347, ('nl', 'sk'): 4.569105787663121, ('nl', 'sl'): 4.2511413144073895, ('nl', 'sv'): 3.8587559721678235, ('pl', 'bg'): 5.59908649823198, ('pl', 'cs'): 3.977189335679069, ('pl', 'da'): 4.8896512995809225, ('pl', 'de'): 4.727433887467663, ('pl', 'el'): 5.593670911860548, ('pl', 'en'): 4.923074290216173, ('pl', 'es'): 4.859492553279613, ('pl', 'et'): 4.847836887923298, ('pl', 'fi'): 4.772403235327544, ('pl', 'fr'): 4.911844249648042, ('pl', 'hu'): 4.710615036873828, ('pl', 'it'): 4.758644214750116, ('pl', 'lt'): 4.487974577361283, ('pl', 'lv'): 4.6363597886353505, ('pl', 'nl'): 4.603020000178009, ('pl', 'pt'): 4.744884288654358, ('pl', 'ro'): 4.563596493319551, ('pl', 'sk'): 3.858065918425999, ('pl', 'sl'): 4.236559814272638, ('pl', 'sv'): 4.848128990921089, ('pt', 'bg'): 4.773334728464249, ('pt', 'cs'): 3.629416895087487, ('pt', 'da'): 4.022597020617858, ('pt', 'de'): 4.073404697697344, ('pt', 'el'): 4.852176165796159, ('pt', 'en'): 3.78955927704936, ('pt', 'es'): 2.1718028391859505, ('pt', 'et'): 3.8799395264262664, ('pt', 'fi'): 4.000383409309435, ('pt', 'fr'): 3.2544337961406726, ('pt', 'hu'): 3.6906636992730273, ('pt', 'it'): 3.1816412191785335, ('pt', 'lt'): 3.924138043552448, ('pt', 'lv'): 4.0428109333074, ('pt', 'nl'): 3.7278190906181945, ('pt', 'pl'): 3.658111320009359, ('pt', 'ro'): 3.0370481609002953, ('pt', 'sk'): 3.683881115664888, ('pt', 'sl'): 3.7047443961723743, ('pt', 'sv'): 4.038772709284282, ('ro', 'bg'): 5.749667843107654, ('ro', 'cs'): 4.703796452866429, ('ro', 'da'): 4.857268468983406, ('ro', 'de'): 4.910786018837503, ('ro', 'el'): 5.7797172407512525, ('ro', 'en'): 4.613455451508227, ('ro', 'es'): 4.114707609738481, ('ro', 'et'): 4.731031471505972, ('ro', 'fi'): 4.870965384776839, ('ro', 'fr'): 4.219507817684554, ('ro', 'hu'): 4.730305901949606, ('ro', 'it'): 4.1334472230421895, ('ro', 'lt'): 4.8023639168427925, ('ro', 'lv'): 4.893339827349798, ('ro', 'nl'): 4.564773798276238, ('ro', 'pl'): 4.680698819617111, ('ro', 'pt'): 4.088336766564862, ('ro', 'sk'): 4.736670831862422, ('ro', 'sl'): 4.752729352077551, ('ro', 'sv'): 4.832442466605805, ('sk', 'bg'): 4.356639546143006, ('sk', 'cs'): 1.5918789579838977, ('sk', 'da'): 3.748068773773023, ('sk', 'de'): 3.6679414099260166, ('sk', 'el'): 4.371633053093072, ('sk', 'en'): 3.733823039068796, ('sk', 'es'): 3.549891091118454, ('sk', 'et'): 3.54846002783962, ('sk', 'fi'): 3.5000010665003876, ('sk', 'fr'): 3.493266146205117, ('sk', 'hu'): 3.3067070433920702, ('sk', 'it'): 3.5684027090699018, ('sk', 'lt'): 3.4459500675668324, ('sk', 'lv'): 3.544470180024962, ('sk', 'nl'): 3.5826360142266696, ('sk', 'pl'): 2.97700331583282, ('sk', 'pt'): 3.3876648105889005, ('sk', 'ro'): 3.340763675982291, ('sk', 'sl'): 2.7210709184150232, ('sk', 'sv'): 3.7752728247039613, ('sl', 'bg'): 4.255260199418003, ('sl', 'cs'): 2.423619878207927, ('sl', 'da'): 3.478504759771054, ('sl', 'de'): 3.299890918663599, ('sl', 'el'): 4.247470235399937, ('sl', 'en'): 3.543356864325425, ('sl', 'es'): 3.4063183866529254, ('sl', 'et'): 3.2031169100688177, ('sl', 'fi'): 3.226482781514058, ('sl', 'fr'): 3.356356044098517, ('sl', 'hu'): 3.321380130432799, ('sl', 'it'): 3.2220899587879277, ('sl', 'lt'): 3.153619864494361, ('sl', 'lv'): 3.175010787650122, ('sl', 'nl'): 3.163429395107742, ('sl', 'pl'): 2.764350603852932, ('sl', 'pt'): 3.239084315520118, ('sl', 'ro'): 3.172532701187723, ('sl', 'sk'): 2.352154217730062, ('sl', 'sv'): 3.467425932373569, ('sv', 'bg'): 4.800426714717907, ('sv', 'cs'): 3.9683634110481196, ('sv', 'da'): 2.7289023583943743, ('sv', 'de'): 3.6576401661376177, ('sv', 'el'): 4.789449527227823, ('sv', 'en'): 4.045993804254776, ('sv', 'es'): 4.001001197975645, ('sv', 'et'): 3.761758144338394, ('sv', 'fi'): 3.824900001945191, ('sv', 'fr'): 3.8444027427764706, ('sv', 'hu'): 3.940098687920383, ('sv', 'it'): 3.7999914653393376, ('sv', 'lt'): 4.1100169157955895, ('sv', 'lv'): 3.9249414136030514, ('sv', 'nl'): 3.7028308410558006, ('sv', 'pl'): 3.938503110357919, ('sv', 'pt'): 4.017918658288329, ('sv', 'ro'): 3.9370263108334838, ('sv', 'sk'): 3.914699189593431, ('sv', 'sl'): 3.9726866207137173}


BASE_DIR = Path("experiments/") 
METRIC = "chrf" if len(sys.argv) <= 2 else sys.argv[2]

def mean(ls):
    return sum(ls) / len(ls)

def read_scores(experiment_dir):
    try:
        with open(Path(experiment_dir) / "scores.json") as reader:
            data = json.load(reader)
    except:
        data = None
    return data

PREFIX = "exp5"
top_dirs = list(BASE_DIR.glob(f"{PREFIX}-*")) 

xs = []
ys = []
for top_dir in top_dirs:
    exp_dirs = list(top_dir.glob(f"{PREFIX}-*-*-v*")) 
    results = dict()
    for exp_dir in exp_dirs:
        exp_dir_name = str(exp_dir.name)
        _, _, tuning, num_train_lines, trial = exp_dir_name.split('-')
        num_train_lines = int(num_train_lines)
        if tuning.startswith("bi"):
            tuning = "bi"
        if (tuning, num_train_lines) not in results:
            results[(tuning, num_train_lines)] = []
        results[(tuning, num_train_lines)].append(exp_dir)

    score_map = dict()
    for tuning, num_train_lines in sorted(results):
        exp_dirs = results[(tuning, num_train_lines)]
        trial_scores = []
        if tuning == 'multi' and len(exp_dirs) == 1:
            config_file = list(exp_dirs[0].glob(f"experiment*.json"))[0]
            with open(config_file) as reader:
                data = json.load(reader)
                langs = tuple([x['src'] for x in data['bitexts']])
                
                
        for exp_dir in exp_dirs:
            scores = read_scores(exp_dir)
            if scores is not None:
                score_avg = mean([scores[lang_pair][METRIC] for lang_pair in scores])
                trial_scores.append(score_avg)
        if len(trial_scores) > 0:
            score_map[tuning] = mean(trial_scores)
     
    if 'bi' in score_map and 'multi' in score_map:           
        lang1, lang2 = langs
        xs.append((divergences[(lang1, lang2)] + divergences[(lang2, lang1)]) )
        ys.append(score_map['multi'] - score_map['bi'])

import seaborn as sns
import matplotlib.pyplot as plt

import scipy.stats as stats

corr, p_value = stats.pearsonr(xs, ys)
print(len(xs))
print(f"Correlation: {corr}, p-value: {p_value}")

print(f'xs={xs}')
print(f'ys={ys}')


# Plot regression line with scatter points
sns.regplot(x=xs, y=ys, ci=None)  
plt.xlabel("Jeffreys Distance")
plt.ylabel("ChrF(multitune) - ChrF(bitune)")
plt.savefig("exp5.png", dpi=300, bbox_inches="tight")